
'use server';
/**
 * @fileOverview An AI agent that answers student questions using a chatbot interface.
 *
 * - answerQuestionWithAIChatbot - A function that handles the question answering process.
 * - AnswerQuestionWithAIChatbotInput - The input type for the answerQuestionWithAIChatbot function.
 * - AnswerQuestionWithAIChatbotOutput - The return type for the answerQuestionWithAIChatbot function.
 */

import {ai} from '@/ai/genkit';
import {z} from 'genkit';

const AnswerQuestionWithAIChatbotInputSchema = z.object({
  question: z.string().describe('The question to be answered by the chatbot.'),
  userId: z.string().describe('The ID of the user asking the question.'),
  fileDataUri: z.string().optional().describe('An optional file (image or PDF) encoded as a Data URI.'),
});
export type AnswerQuestionWithAIChatbotInput = z.infer<typeof AnswerQuestionWithAIChatbotInputSchema>;

const AnswerQuestionWithAIChatbotOutputSchema = z.object({
  answer: z.string().describe('The answer generated by the AI chatbot.'),
});
export type AnswerQuestionWithAIChatbotOutput = z.infer<typeof AnswerQuestionWithAIChatbotOutputSchema>;

export async function answerQuestionWithAIChatbot(input: AnswerQuestionWithAIChatbotInput): Promise<AnswerQuestionWithAIChatbotOutput> {
  // To connect to your AI system on Render, we call it here.
  const renderApiUrl = process.env.RENDER_AI_API_URL;

  if (!renderApiUrl) {
    console.error("RENDER_AI_API_URL is not set in .env file.");
    return { answer: "La connexion au système IA externe n'est pas configurée. Veuillez définir RENDER_AI_API_URL." };
  }

  try {
    // We construct the payload to match what the Python backend expects.
    // The keys sent to the python backend must match what it expects.
    const payload: {
        question: string;
        user_id: string;
        file_data_uri?: string;
    } = {
        question: input.question,
        user_id: input.userId,
    };

    if (input.fileDataUri) {
        payload.file_data_uri = input.fileDataUri;
    }

    const response = await fetch(renderApiUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(payload),
    });

    if (!response.ok) {
      const errorBody = await response.text();
      throw new Error(`API request failed with status ${response.status}: ${errorBody}`);
    }

    const result = await response.json();
    
    // We ensure the output matches the expected schema
    return AnswerQuestionWithAIChatbotOutputSchema.parse(result);

  } catch (error: any) {
    console.error("Error calling external AI system:", error);
    return { answer: `Désolé, une erreur est survenue lors de la communication avec le système IA. (${error.message})` };
  }
}

// The original Genkit flow is kept below for reference but is no longer used by the function above.

const prompt = ai.definePrompt({
  name: 'answerQuestionWithAIChatbotPrompt',
  input: {schema: AnswerQuestionWithAIChatbotInputSchema},
  output: {schema: AnswerQuestionWithAIChatbotOutputSchema},
  prompt: `You are a helpful AI chatbot assisting students with their studies.

  Answer the following question to the best of your ability:

  Question: {{{question}}}`,
});

const answerQuestionWithAIChatbotFlow = ai.defineFlow(
  {
    name: 'answerQuestionWithAIChatbotFlow',
    inputSchema: AnswerQuestionWithAIChatbotInputSchema,
    outputSchema: AnswerQuestionWithAIChatbotOutputSchema,
  },
  async input => {
    const {output} = await prompt(input);
    return output!;
  }
);
